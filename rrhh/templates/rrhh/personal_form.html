{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP · RRHH · Registrar personal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary-dark:#0a0e1a; --secondary-dark:#1a1f2e; --accent-dark:#2a3441;
      --primary-blue:#2563eb; --secondary-blue:#1d4ed8; --light-blue:#3b82f6; --accent-blue:#60a5fa;
      --pure-white:#ffffff; --light-gray:#f8fafc; --medium-gray:#94a3b8; --dark-gray:#1f2937;
      --glass-bg:rgba(255,255,255,.08); --glass-border:rgba(255,255,255,.14);
      --gradient-blue:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
      --gradient-accent:linear-gradient(135deg,#22d3ee 0%,#6366f1 100%);
      --shadow-soft:0 25px 40px rgba(15,23,42,0.45);
      --shadow-card:0 15px 30px rgba(15,23,42,0.4);
      --radius-xl:24px;
      --transition:all .4s cubic-bezier(.4,0,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',sans-serif;
      background:radial-gradient(circle at top,#111827 0%,#020617 60%,#01030c 100%);
      color:var(--pure-white);
      min-height:100vh;
      position:relative;
      overflow-y:auto;
    }

    .background-effects{position:fixed; inset:0; pointer-events:none; z-index:-1}
    .gradient-orb{position:absolute; width:420px; height:420px; border-radius:50%; filter:blur(50px); opacity:.35; mix-blend-mode:screen; animation:float 14s ease-in-out infinite}
    .orb-1{background:var(--gradient-blue); top:-120px; left:-80px}
    .orb-2{background:var(--gradient-accent); bottom:-140px; right:-100px; animation-delay:3s}
    .orb-3{background:radial-gradient(circle at 30% 30%,#60a5fa,#1d4ed8); top:40%; left:55%; animation-delay:4s}
    .grid-pattern{position:absolute; inset:0; background-image:linear-gradient(rgba(255,255,255,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.06) 1px,transparent 1px); background-size:40px 40px; mask-image:radial-gradient(ellipse at center,rgba(0,0,0,.85),transparent 70%); animation:gridShift 30s linear infinite}
    @keyframes float{50%{transform:translateY(-20px) scale(1.03)}}
    @keyframes gridShift{to{background-position:40px 40px}}

    header.header{position:sticky; top:0; z-index:30; padding:12px 20px; background:rgba(10,14,26,.6); backdrop-filter:blur(18px); border-bottom:1px solid var(--glass-border); animation:slideInDown .6s ease both}
    .header-content{max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between}
    .logo-section{display:flex; align-items:center; gap:12px}
    .logo-section img{height:48px; filter:brightness(1.2); transition:var(--transition)}
    .logo-section img:hover{filter:brightness(1.5)}
    .system-title{margin:0; font-size:1.05rem; font-weight:800; letter-spacing:.35px}
    .user-section{display:flex; align-items:center; gap:18px}
    .system-status{display:flex; align-items:center; gap:8px; color:var(--accent-blue); font-weight:600}
    .status-indicator{width:10px; height:10px; border-radius:50%; background:var(--accent-blue); box-shadow:0 0 12px var(--accent-blue)}
    .user-profile{display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:16px; background:var(--glass-bg); border:1px solid var(--glass-border)}
    .user-avatar{width:32px; height:32px; border-radius:10px; display:grid; place-items:center; background:var(--gradient-blue); font-weight:700}

    main.container{max-width:1100px; margin:28px auto 60px; padding:0 20px; animation:fadeInUp .5s ease both}
    .breadcrumb{color:var(--accent-blue); font-size:.9rem; margin-bottom:6px; letter-spacing:.2px}
    .page-head{display:flex; flex-wrap:wrap; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:18px}
    .title{margin:0; font-size:1.7rem; font-weight:800}
    .desc{margin:4px 0 0; color:var(--medium-gray)}

    .card{background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:var(--radius-xl); padding:22px; backdrop-filter:blur(28px); box-shadow:var(--shadow-soft); margin-bottom:20px}
    .card h2{font-size:1.1rem; margin:0 0 18px; font-weight:700}

    form{display:block}
    .form-grid{display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:16px}
    .form-grid.full{grid-template-columns:1fr}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-weight:600; font-size:.95rem; color:var(--light-gray)}
    .field input[type="text"],
    .field input[type="email"],
    .field input[type="date"],
    .field select{
      background:rgba(15,23,42,.7);
      border:1px solid rgba(148,163,184,.2);
      border-radius:12px;
      padding:.75rem .85rem;
      color:var(--pure-white);
      font-size:.95rem;
      transition:var(--transition);
    }
    .field input:focus,
    .field select:focus{outline:2px solid var(--primary-blue); outline-offset:2px; background:rgba(37,99,235,.08)}
    .field input::placeholder{color:rgba(226,232,240,.6)}
    .field .help-text{font-size:.8rem; color:var(--medium-gray)}
    .field .errorlist{margin:0; padding:0; list-style:none; color:#f87171; font-size:.85rem}

    .switch-field{display:flex; align-items:center; gap:12px; padding:12px 16px; background:rgba(15,23,42,.6); border:1px solid rgba(148,163,184,.2); border-radius:14px}
    .switch-field label{margin:0; font-size:.95rem; font-weight:600}

    .children-card{display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:16px; padding:18px; margin-top:12px; border-radius:18px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.65); position:relative; box-shadow:var(--shadow-card)}
    .children-card h3{grid-column:1 / -1; font-size:1rem; margin:0 0 6px; font-weight:700; color:var(--accent-blue)}
    .children-card[data-active="false"]{display:none}

    .form-actions{display:flex; justify-content:flex-end; gap:12px; margin-top:24px}
    .btn{display:inline-grid; place-items:center; border-radius:12px; padding:.7rem 1.4rem; font-weight:700; cursor:pointer; border:1px solid var(--glass-border); background:var(--glass-bg); color:var(--pure-white); text-decoration:none; transition:var(--transition)}
    .btn-primary{background:var(--gradient-blue); border-color:transparent}
    .btn:hover{transform:translateY(-1px)}

    .messages{display:flex; flex-direction:column; gap:10px; margin-bottom:18px}
    .message{padding:12px 16px; border-radius:14px; border:1px solid rgba(148,163,184,.2); background:rgba(15,23,42,.65); display:flex; align-items:center; gap:12px}
    .message.success{border-color:rgba(34,197,94,.4); background:rgba(34,197,94,.12); color:#bbf7d0}
    .message.error{border-color:rgba(248,113,113,.4); background:rgba(248,113,113,.14); color:#fecaca}

    @keyframes slideInDown{from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    @media (max-width:900px){
      .form-grid{grid-template-columns:1fr}
      .children-card{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="background-effects">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
    <div class="grid-pattern"></div>
  </div>

  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <img src="{% static 'images/textoanhe-removebg-preview.png' %}" alt="ANHE logo" />
        <p class="system-title">ERP · Gestión de RRHH</p>
      </div>
      <div class="user-section">
        <div class="system-status"><span class="status-indicator"></span>Operativo</div>
        <div class="user-profile">
          <div class="user-avatar">RH</div>
          <div>
            <div style="font-weight:700">Recursos Humanos</div>
            <div style="font-size:.8rem; color:var(--medium-gray)">Panel administrativo</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="breadcrumb">RRHH / Personal</div>
    <div class="page-head">
      <div>
        <h1 class="title">Registrar nuevo personal</h1>
        <p class="desc">Completa la información del colaborador y define los datos de sus hijos en un solo flujo.</p>
      </div>
      <div class="btn btn-secondary" role="link" style="background:linear-gradient(135deg,#334155,#1f2937); border-color:transparent" onclick="window.history.back()">Volver</div>
    </div>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      {{ personal_form.non_field_errors }}

      <section class="card">
        <h2>Datos generales</h2>
        <div class="form-grid">
          <div class="field">
            <label for="id_nombres">{{ personal_form.nombres.label }}</label>
            {{ personal_form.nombres }}
            {{ personal_form.nombres.errors }}
          </div>
          <div class="field">
            <label for="id_apellidos">{{ personal_form.apellidos.label }}</label>
            {{ personal_form.apellidos }}
            {{ personal_form.apellidos.errors }}
          </div>
          <div class="field">
            <label for="id_dni">{{ personal_form.dni.label }}</label>
            {{ personal_form.dni }}
            {{ personal_form.dni.errors }}
          </div>
          <div class="field">
            <label for="id_cargo">{{ personal_form.cargo.label }}</label>
            {{ personal_form.cargo }}
            {{ personal_form.cargo.errors }}
          </div>
          <div class="field">
            <label for="id_profesion">{{ personal_form.profesion.label }}</label>
            {{ personal_form.profesion }}
            {{ personal_form.profesion.errors }}
          </div>
          <div class="field">
            <label for="id_correo">{{ personal_form.correo.label }}</label>
            {{ personal_form.correo }}
            {{ personal_form.correo.errors }}
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Información laboral</h2>
        <div class="form-grid">
          <div class="field">
            <label for="id_empresa_afp">{{ personal_form.empresa_afp.label }}</label>
            {{ personal_form.empresa_afp }}
            {{ personal_form.empresa_afp.errors }}
          </div>
          <div class="field">
            <label for="id_numero_afp">{{ personal_form.numero_afp.label }}</label>
            {{ personal_form.numero_afp }}
            {{ personal_form.numero_afp.errors }}
          </div>
          <div class="field">
            <label for="id_tipo_comision_afp">{{ personal_form.tipo_comision_afp.label }}</label>
            {{ personal_form.tipo_comision_afp }}
            {{ personal_form.tipo_comision_afp.errors }}
          </div>
          <div class="field">
            <label for="id_bono">{{ personal_form.bono.label }}</label>
            {{ personal_form.bono }}
            {{ personal_form.bono.errors }}
          </div>
          <div class="field">
            <label for="id_modalidad">{{ personal_form.modalidad.label }}</label>
            {{ personal_form.modalidad }}
            {{ personal_form.modalidad.errors }}
          </div>
          <div class="field">
            <label for="id_id_proyecto">Proyecto asignado</label>
            {{ personal_form.id_proyecto }}
            {{ personal_form.id_proyecto.errors }}
          </div>
        </div>
        <div class="form-grid">
          <div class="field">
            <label for="id_fecha_ingreso">{{ personal_form.fecha_ingreso.label }}</label>
            {{ personal_form.fecha_ingreso }}
            {{ personal_form.fecha_ingreso.errors }}
          </div>
          <div class="field">
            <label for="id_inicio_de_contrato">{{ personal_form.inicio_de_contrato.label }}</label>
            {{ personal_form.inicio_de_contrato }}
            {{ personal_form.inicio_de_contrato.errors }}
          </div>
          <div class="field">
            <label for="id_vencimiento_contrato">{{ personal_form.vencimiento_contrato.label }}</label>
            {{ personal_form.vencimiento_contrato }}
            {{ personal_form.vencimiento_contrato.errors }}
          </div>
          <div class="switch-field">
            {{ personal_form.activo }}
            <label for="id_activo">{{ personal_form.activo.label }}</label>
            {{ personal_form.activo.errors }}
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Contacto y domicilio</h2>
        <div class="form-grid">
          <div class="field">
            <label for="id_domicilio">{{ personal_form.domicilio.label }}</label>
            {{ personal_form.domicilio }}
            {{ personal_form.domicilio.errors }}
          </div>
          <div class="field">
            <label for="id_contacto_emergencia">{{ personal_form.contacto_emergencia.label }}</label>
            {{ personal_form.contacto_emergencia }}
            {{ personal_form.contacto_emergencia.errors }}
          </div>
          <div class="field">
            <label for="id_num_emergencia">{{ personal_form.num_emergencia.label }}</label>
            {{ personal_form.num_emergencia }}
            {{ personal_form.num_emergencia.errors }}
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Hijos del colaborador</h2>
        <p class="desc" style="margin-bottom:16px">Selecciona el número de hijos para desplegar los formularios correspondientes.</p>
        <div class="form-grid">
          <div class="field">
            <label for="childrenCount">Número de hijos</label>
            <select id="childrenCount" name="children_count">
              {% for option in children_options %}
                <option value="{{ option }}" {% if option == selected_children %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        {{ hijo_formset.management_form }}
        {% for child_form in hijo_formset %}
          <div class="children-card" data-index="{{ forloop.counter0 }}" data-active="false">
            <h3>Hijo {{ forloop.counter }}</h3>
            <div class="field">
              <label>Nombre completo</label>
              {{ child_form.nombre_hijo }}
              {{ child_form.nombre_hijo.errors }}
            </div>
            <div class="field">
              <label>Fecha de nacimiento</label>
              {{ child_form.cumpleaños_hijo }}
              {{ child_form.cumpleaños_hijo.errors }}
            </div>
            {% if child_form.non_field_errors %}
              <div class="field" style="grid-column:1 / -1">
                <ul class="errorlist">{% for error in child_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</ul>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </section>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Registrar personal</button>
      </div>
    </form>
  </main>

  <script>
    (function(){
  const selector = document.getElementById('childrenCount');
  const cards = Array.from(document.querySelectorAll('.children-card'));
  const selected = Number('{{ selected_children|default:0 }}');

      function syncChildren(){
        const count = parseInt(selector.value, 10) || 0;
        cards.forEach((card, index) => {
          const active = index < count;
          card.dataset.active = active ? 'true' : 'false';
          if(!active){
            card.querySelectorAll('input').forEach(input => {
              if(input.type !== 'hidden'){ input.value = ''; }
            });
          }
        });
      }

      if(selector){
        selector.addEventListener('change', syncChildren);
  if(!Number.isNaN(selected)){ selector.value = selected; }
        syncChildren();
      }
    })();
  </script>
</body>
</html>
