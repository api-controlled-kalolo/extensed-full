{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP · Registrar Cotización</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary-dark:#0a0e1a; --secondary-dark:#1a1f2e; --accent-dark:#2a3441;
      --primary-blue:#2563eb; --secondary-blue:#1d4ed8; --light-blue:#3b82f6; --accent-blue:#60a5fa;
      --pure-white:#ffffff; --light-gray:#f8fafc; --medium-gray:#94a3b8; --dark-gray:#334155;
      --glass-bg:rgba(255,255,255,.08); --glass-border:rgba(255,255,255,.12);
      --gradient-primary:linear-gradient(135deg,#1e293b 0%,#0f172a 50%,#1e293b 100%);
      --gradient-blue:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
      --gradient-accent:linear-gradient(135deg,#3b82f6 0%,#1e40af 100%);
      --shadow-soft:0 4px 20px rgba(0,0,0,.15);
      --shadow-medium:0 8px 32px rgba(0,0,0,.24);
      --transition:all .4s cubic-bezier(.4,0,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; color:var(--pure-white); background:var(--gradient-primary); overflow-x:hidden}

    /* Fondo */
    .background-effects{position:fixed; inset:0; pointer-events:none; z-index:-1}
    .gradient-orb{position:absolute; width:420px; height:420px; border-radius:50%; filter:blur(50px); opacity:.35; mix-blend-mode:screen; animation:float 14s ease-in-out infinite}
    .orb-1{background:var(--gradient-blue); top:-100px; left:-80px}
    .orb-2{background:var(--gradient-accent); bottom:-120px; right:-60px; animation-delay:2s}
    .orb-3{background:radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8); top:40%; left:55%; animation-delay:4s}
    .grid-pattern{position:absolute; inset:0; background-image:linear-gradient(rgba(255,255,255,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.06) 1px,transparent 1px); background-size:40px 40px; mask-image:radial-gradient(ellipse at center, rgba(0,0,0,.8), transparent 70%); animation:gridShift 30s linear infinite}
    @keyframes float{50%{transform:translateY(-20px) scale(1.03)}} @keyframes gridShift{to{background-position:40px 40px}}

    /* Header */
    .header{position:sticky; top:0; z-index:30; padding:12px 20px; background:rgba(10,14,26,.55); backdrop-filter:blur(16px); border-bottom:1px solid var(--glass-border); animation:slideInDown .6s ease both}
    .header-content{max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between}
    .logo-section{display:flex; align-items:center; gap:12px}
    .logo-section img{height:48px; filter:brightness(1.2); transition:var(--transition)}
    .logo-section img:hover{filter:brightness(1.5)}
    .system-title{margin:0; font-size:1.05rem; font-weight:800; letter-spacing:.4px}

    .user-section{display:flex; align-items:center; gap:18px}
    .system-status{display:flex; align-items:center; gap:8px; color:var(--accent-blue); font-weight:600}
    .status-indicator{width:10px; height:10px; border-radius:50%; background:var(--accent-blue); box-shadow:0 0 12px var(--accent-blue)}
    .user-profile{display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:16px; background:var(--glass-bg); border:1px solid var(--glass-border)}
    .user-avatar{width:32px; height:32px; border-radius:10px; display:grid; place-items:center; background:var(--gradient-blue); font-weight:700}

    /* Contenido */
    .container{max-width:1100px; margin:28px auto; padding:0 20px; animation:fadeInUp .5s ease both}
    .breadcrumb{color:var(--accent-blue); font-size:.9rem; margin-bottom:6px}
    .page-head{display:flex; align-items:end; justify-content:space-between; gap:16px; margin-bottom:18px}
    .title{margin:0; font-size:1.6rem; font-weight:800}
    .desc{margin:4px 0 0; color:var(--light-gray)}

    /* Tarjetas / formularios */
    .card{
      background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:20px;
      padding:22px; backdrop-filter:blur(25px); box-shadow:var(--shadow-soft);
    }

    .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:16px}
    .form-grid-3{display:grid; grid-template-columns:2fr 1fr 1fr; gap:12px}
    .field label{display:block; font-weight:700; margin-bottom:6px}
    .help{font-size:.85rem; color:var(--accent-blue); margin-top:4px}
    .badge-info{display:inline-block; padding:.35rem .6rem; border-radius:10px; background:rgba(59,130,246,.16); border:1px solid rgba(96,165,250,.35); color:var(--accent-blue); font-weight:700; font-size:.85rem}

    /* Inputs */
    .form-control,.form-select, textarea.form-control{
      width:100%; padding:.75rem .9rem; border-radius:12px;
      border:1px solid var(--glass-border); background:rgba(255,255,255,.06);
      color:var(--pure-white); transition:var(--transition);
      color-scheme:dark; appearance:none;
    }
    select{
      color:var(--pure-white);
      color-scheme:dark;
    }
    .form-select option, select option{background:#0b1220; color:var(--pure-white)}
    .form-select optgroup{background:#0b1220; color:var(--pure-white)}
    .form-control::placeholder{color:var(--medium-gray)}
    .form-control:focus,.form-select:focus,textarea.form-control:focus{outline:2px solid var(--primary-blue); outline-offset:2px; background:rgba(37,99,235,.08)}
    
    /* Checkbox styling */
    .form-check-input{
      width:18px; height:18px; margin-right:8px; border-radius:4px;
      border:2px solid var(--glass-border); background:rgba(255,255,255,.06);
      cursor:pointer; transition:var(--transition);
    }
    .form-check-input:checked{
      background:var(--primary-blue); border-color:var(--primary-blue);
    }
    .form-check-input:focus{
      outline:2px solid var(--primary-blue); outline-offset:2px;
    }
    
    .errorlist{margin:.3rem 0 0; padding:0; list-style:none; color:#fecaca; font-size:.85rem}

    /* Tabla de partidas */
    .items{margin-top:18px}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    thead th{font-size:.9rem; font-weight:800; color:var(--light-gray); text-align:left; padding:0 10px}
    tbody tr{background:rgba(255,255,255,.06); border:1px solid var(--glass-border); border-radius:12px}
    tbody td{padding:10px}
    tbody tr>td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr>td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
    .total-display{width:100%; padding:.7rem .9rem; border-radius:12px; border:1px dashed rgba(148,163,184,.4); background:rgba(255,255,255,.04); color:var(--pure-white)}
    .btn-icon, .btn-small{
      display:inline-grid; place-items:center; border-radius:10px; border:1px solid var(--glass-border);
      background:var(--glass-bg); color:var(--pure-white); padding:.55rem .8rem; cursor:pointer; transition:var(--transition); text-decoration:none; font-weight:700
    }
    .btn-icon:hover, .btn-small:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--gradient-blue); border-color:transparent}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c); border-color:transparent}
    .btn-secondary{background:linear-gradient(135deg,#334155,#1f2937); border-color:transparent}

    .actions-footer{display:flex; gap:10px; justify-content:flex-end; margin-top:16px}

    /* Resumen */
    .resume{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; margin-top:12px}
    .totals{
      min-width:300px; padding:12px 16px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid var(--glass-border);
    }
    .totals-row{display:flex; justify-content:space-between; align-items:center; margin:.2rem 0; font-size:1rem;}
    .totals-row strong{font-weight:800; display:flex; align-items:center; gap:6px; letter-spacing:.01em}
    .totals-row.total{font-size:1rem}
    .totals-row .currency{display:inline-flex; align-items:center}

    @media (max-width:900px){
      .form-grid{grid-template-columns:1fr}
      .form-grid-3{grid-template-columns:1fr}
    }

    /* Animaciones */
    @keyframes slideInDown{from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    /* Nav icons */
    .nav-icons{display:flex;align-items:center;gap:10px}
    .icon-btn{display:grid;place-items:center;width:36px;height:36px;border-radius:12px;background:var(--glass-bg);border:1px solid var(--glass-border);color:var(--pure-white);text-decoration:none;transition:var(--transition);outline:none}
    .icon-btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.22);box-shadow:var(--shadow-soft)}
    .icon-btn:focus{outline:2px solid var(--primary-blue);outline-offset:3px}
    .icon-btn svg{width:20px;height:20px}
  </style>
</head>
<body>
  <!-- Fondo -->
  <div class="background-effects">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
    <div class="grid-pattern"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <img src="https://i.ibb.co/wFRJS8cw/textoanhe-removebg-preview.png" alt="Logo de la empresa" />
        <h1 class="system-title">ERP · Cotizaciones</h1>

        <div class="nav-icons" role="group" aria-label="Navegación rápida">
          <a class="icon-btn" href="{% url 'ventas:modulo_ventas' %}" title="Inicio" aria-label="Inicio">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 10.5L12 3l9 7.5"></path><path d="M5 11.5v9h4v-6h4v6h4v-9"></path>
            </svg>
          </a>
          <a class="icon-btn" href="{% url 'ventas:cotizaciones_list' %}" title="Listado" aria-label="Listado de cotizaciones">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h10l4 4v12H4z"/><path d="M14 4v4h4"/><path d="M8 12h8M8 16h5"/></svg>
          </a>
        </div>
      </div>
      <div class="user-section">
        <div class="system-status"><div class="status-indicator" aria-hidden="true"></div><span>Sistema Operativo</span></div>
        <div class="user-profile" role="group" aria-label="Perfil de usuario">
          <div class="user-avatar" aria-hidden="true">{{ user.first_name.0|default:'U' }}</div>
          <div class="user-details">
            <div class="user-name">Hola, {{ user.get_full_name|default:user.username|default:'Usuario' }}!</div>
            <div class="user-role">Ventas</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido -->
  <main class="container">
    <div class="breadcrumb">Ventas / Cotizaciones</div>
    <div class="page-head">
      <div>
        <h2 class="title">Registrar Cotización</h2>
        <p class="desc">Completa los datos de la cabecera y agrega las partidas. <span class="badge-info">El número de cotización se generará automáticamente al guardar.</span></p>
      </div>
    </div>

    {% if form.errors or detalles_formset.non_form_errors %}
      <div class="card" style="border-color:#7f1d1d; background:rgba(127,29,29,.2); margin-bottom:16px;">
        <strong>Revisa los campos:</strong>
        {{ form.non_field_errors }}
        {{ detalles_formset.non_form_errors }}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <!-- CABECERA -->
      <section class="card" aria-labelledby="cabecera-title">
        <h3 id="cabecera-title" style="margin:0 0 12px; font-size:1.1rem; font-weight:800;">Datos de la Cotización</h3>
        <div class="form-grid">
          <div class="field">
            <label for="{{ form.nombre_cotizacion.id_for_label }}">Nombre de la cotización</label>
            {{ form.nombre_cotizacion }} {{ form.nombre_cotizacion.errors }}
          </div>

          <div class="field">
            <label for="{{ form.cliente.id_for_label }}">Cliente</label>
            {{ form.cliente }} {{ form.cliente.errors }}
          </div>

          <div class="field">
            <label for="{{ form.contacto.id_for_label }}">Contacto</label>
            {{ form.contacto }} {{ form.contacto.errors }}
          </div>

          <div class="field">
            <label for="{{ form.direccion.id_for_label }}">Dirección</label>
            {{ form.direccion }} {{ form.direccion.errors }}
          </div>

          <div class="field">
            <label for="{{ form.correo.id_for_label }}">Correo del cliente</label>
            {{ form.correo }} {{ form.correo.errors }}
          </div>

          <div class="field">
            <label for="{{ form.celular.id_for_label }}">Celular del cliente</label>
            {{ form.celular }} {{ form.celular.errors }}
          </div>
          
          <div class="field">
            <label for="{{ form.forma_pago.id_for_label }}">Forma de Pago</label>
            {{ form.forma_pago }} {{ form.forma_pago.errors }}
          </div>

          <div class="field">
            <label for="{{ form.validez_oferta.id_for_label }}">Validez de la Oferta</label>
            {{ form.validez_oferta }} {{ form.validez_oferta.errors }}
          </div>

          <div class="field">
            <label for="{{ form.moneda.id_for_label }}">Moneda</label>
            {{ form.moneda }} {{ form.moneda.errors }}
          </div>

          <div class="field">
            <label for="{{ form.incluye_igv.id_for_label }}">¿Incluye IGV?</label>
            {{ form.incluye_igv }} {{ form.incluye_igv.errors }}
            <div class="help">Marcar si los precios incluyen IGV (18%)</div>
          </div>

          <div class="field">
            <label for="{{ form.estado_coti.id_for_label }}">Estado de la Cotización</label>
            {{ form.estado_coti }} {{ form.estado_coti.errors }}
          </div>

          <!-- Los datos del contacto se eligen mediante el select 'contacto' -->

          <div class="field" style="grid-column:1/-1">
            <label for="{{ form.alcance_total_oferta.id_for_label }}">Alcance total de la oferta</label>
            {{ form.alcance_total_oferta }} {{ form.alcance_total_oferta.errors }}
            <div class="help">Describe brevemente el alcance completo (servicios, condiciones y observaciones).</div>
          </div>
        </div>
      </section>

      <!-- PARTIDAS -->
      <section class="card items" aria-labelledby="items-title">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px;">
          <h3 id="items-title" style="margin:0; font-size:1.1rem; font-weight:800;">Partidas / Ítems</h3>
          <button class="btn-small btn-secondary" type="button" id="add-row">+ Agregar ítem</button>
        </div>

        {{ detalles_formset.management_form }}

        <div class="table-wrapper">
          <table aria-describedby="items-title">
            <thead>
              <tr>
                <th style="width:42%;">Descripción</th>
                <th style="width:14%;">Unidad</th>
                <th style="width:12%;">Cantidad</th>
                <th style="width:16%;">Precio Unitario</th>
                <th style="width:16%;">Total</th>
                <th style="width:8%;">Acciones</th>
              </tr>
            </thead>
            <tbody id="items-rows">
              {% for f in detalles_formset.forms %}
                <tr data-form-index="{{ forloop.counter0 }}">
                  <!-- ID oculto si existe -->
                  {% if f.id %}{{ f.id }}{% endif %}
                  <td>
                    {{ f.descripcion }} {{ f.descripcion.errors }}
                  </td>
                  <td>
                    {{ f.unidad }} {{ f.unidad.errors }}
                  </td>
                  <td>
                    {{ f.cantidad }} {{ f.cantidad.errors }}
                  </td>
                  <td>
                    {{ f.precio_unitario }} {{ f.precio_unitario.errors }}
                  </td>
                  <td>
                    <input type="text" class="total-display" value="0.00" inputmode="decimal" readonly aria-label="Total calculado">
                  </td>
                  <td>
                    {% if f.DELETE %}{{ f.DELETE }}{% endif %}
                    <button type="button" class="btn-icon btn-danger remove-row" title="Quitar fila">&times;</button>
                  </td>
                </tr>
              {% empty %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Fila plantilla (empty_form) -->
        <template id="row-template">
          <tr data-form-index="__prefix__">
            {{ detalles_formset.empty_form.id }}
            <td>{{ detalles_formset.empty_form.descripcion }}</td>
            <td>{{ detalles_formset.empty_form.unidad }}</td>
            <td>{{ detalles_formset.empty_form.cantidad }}</td>
            <td>{{ detalles_formset.empty_form.precio_unitario }}</td>
            <td><input type="text" class="total-display" value="0.00" inputmode="decimal" readonly aria-label="Total calculado"></td>
            <td><button type="button" class="btn-icon btn-danger remove-row" title="Quitar fila">&times;</button></td>
          </tr>
        </template>

        <!-- Resumen -->
        <div class="resume">
          <div></div>
          <div class="totals" aria-live="polite">
            <div class="totals-row"><span class="totals-label">Subtotal</span><strong class="totals-amount"><span class="currency">S/</span><span id="subtotal">0.00</span></strong></div>
            <div class="totals-row"><span class="totals-label">IGV (18%)</span><strong class="totals-amount"><span class="currency">S/</span><span id="igv">0.00</span></strong></div>
            <div class="totals-row total"><span class="totals-label">Total</span><strong class="totals-amount"><span class="currency">S/</span><span id="total">0.00</span></strong></div>
          </div>
        </div>
      </section>

      <div class="actions-footer">
        <a class="btn-small" href="#">Cancelar</a>
        <button type="submit" class="btn-small btn-primary">Guardar cotización</button>
      </div>
    </form>
  </main>

  <script>
    // ===== Config =====
    const IGV_RATE = 0.18;

    // ===== Helpers =====
    const toFloat = (v) => {
      if (typeof v === 'number') return v;
      if (!v) return 0;
      // admite coma o punto
      const clean = String(v).replace(/[^0-9,.\-]/g, '').replace(',', '.');
      const n = parseFloat(clean);
      return isNaN(n) ? 0 : n;
    };
    const money = (n) => (toFloat(n)).toFixed(2);

    // ===== Formset logic =====
    const rowsTbody = document.getElementById('items-rows');
    const template = document.getElementById('row-template');
    const addBtn = document.getElementById('add-row');
    const subtotalEl = document.getElementById('subtotal');
    const igvEl = document.getElementById('igv');
    const totalEl = document.getElementById('total');

    const mgmtTotal = document.getElementById('{{ detalles_formset.prefix }}-TOTAL_FORMS') ||
                      document.querySelector('input[name$="-TOTAL_FORMS"]');

    function attachRowEvents(tr){
      const qty = tr.querySelector('input[name$="-cantidad"]');
      const price = tr.querySelector('input[name$="-precio_unitario"]');
      const total = tr.querySelector('.total-display');
      const delBtn = tr.querySelector('.remove-row');

      const recalc = () => {
        const t = toFloat(qty?.value) * toFloat(price?.value);
        if (total) total.value = money(t);
        recalcTotals();
      };

      qty && qty.addEventListener('input', recalc);
      price && price.addEventListener('input', recalc);
      delBtn && delBtn.addEventListener('click', () => removeRow(tr));
      // init
      recalc();
    }

    function recalcTotals(){
      let sum = 0;
      rowsTbody.querySelectorAll('tr').forEach(tr => {
        // si tiene checkbox DELETE marcado, lo ignoramos
        const del = tr.querySelector('input[name$="-DELETE"]');
        if (del && del.checked) return;
        const qty = toFloat(tr.querySelector('input[name$="-cantidad"]')?.value);
        const price = toFloat(tr.querySelector('input[name$="-precio_unitario"]')?.value);
        sum += qty * price;
      });
      
      // Verificar si el IGV está incluido
      const igvCheckbox = document.querySelector('input[name="incluye_igv"]');
      const incluyeIGV = igvCheckbox ? igvCheckbox.checked : true;
      
      const igv = incluyeIGV ? (sum * IGV_RATE) : 0;
      const total = sum + igv;
      
      subtotalEl.textContent = money(sum);
      igvEl.textContent = money(igv);
      totalEl.textContent = money(total);
    }

    function addRow(){
      const idx = parseInt(mgmtTotal.value, 10);
      const html = template.innerHTML.replaceAll('__prefix__', idx);
      const wrapper = document.createElement('tbody'); // para parsear html
      wrapper.innerHTML = html.trim();
      const tr = wrapper.firstElementChild;
      rowsTbody.appendChild(tr);
      mgmtTotal.value = idx + 1;
      attachRowEvents(tr);
    }

    function removeRow(tr){
      const deleteBox = tr.querySelector('input[name$="-DELETE"]');
      const isNew = !deleteBox; // filas nuevas no traen DELETE
      if (isNew){
        tr.remove();
        mgmtTotal.value = Math.max(0, parseInt(mgmtTotal.value, 10) - 1);
      }else{
        deleteBox.checked = true;
        tr.style.display = 'none';
      }
      recalcTotals();
    }

    // init existentes
    document.querySelectorAll('#items-rows tr').forEach(attachRowEvents);
    addBtn?.addEventListener('click', addRow);
    recalcTotals();

    // ===== Cliente -> Contacto dependiente =====
    (function(){
      const clienteSel = document.getElementById('{{ form.cliente.id_for_label }}');
      const contactoSel = document.getElementById('{{ form.contacto.id_for_label }}');
      if(!clienteSel || !contactoSel) return;

      function setLoading(){
        contactoSel.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Cargando contactos…';
        contactoSel.appendChild(opt);
        contactoSel.disabled = true;
      }

      function setOptions(items){
        contactoSel.innerHTML = '';
        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = '— Selecciona —';
        contactoSel.appendChild(empty);
        for(const it of items){
          const opt = document.createElement('option');
          opt.value = it.id;
          opt.textContent = it.label;
          contactoSel.appendChild(opt);
        }
        contactoSel.disabled = false;
      }

      async function fetchContactos(clienteId){
        if(!clienteId){ setOptions([]); return; }
        setLoading();
        try{
          // Usa la ruta namespaced para asegurar el prefijo correcto (/ventas/...)
          const apiTpl = '{% url "ventas:api_contactos_por_cliente" cliente_id=999999 %}';
          const url = apiTpl.replace('999999', encodeURIComponent(clienteId));
          const res = await fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          setOptions(data.results||[]);
        }catch(e){
          console.error('Error cargando contactos', e);
          setOptions([]);
        }
      }

      // Cargar al cambiar cliente
      clienteSel.addEventListener('change', (e)=>{
        fetchContactos(e.target.value);
      });

      // Si la página carga con cliente seleccionado, precargar
      if(clienteSel.value){
        fetchContactos(clienteSel.value);
      }
    })();

    // ===== Auto-completar Dirección desde Cliente =====
    (function(){
      const clienteSel = document.getElementById('id_cliente');
      const direccionInput = document.querySelector('input[name="direccion"]');
      if(!clienteSel || !direccionInput) return;

      async function fetchDatosCliente(clienteId){
        if(!clienteId){ 
          direccionInput.value = '';
          return;
        }
        try{
          const url = `/ventas/api/clientes/${clienteId}/datos`;
          const res = await fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          
          // Auto-completar dirección
          if(data.direccion){
            direccionInput.value = data.direccion;
          }
        }catch(e){
          console.error('Error cargando datos del cliente', e);
        }
      }

      clienteSel.addEventListener('change', (e)=>{
        fetchDatosCliente(e.target.value);
      });

      // Si la página carga con cliente seleccionado, precargar
      if(clienteSel.value){
        fetchDatosCliente(clienteSel.value);
      }
    })();

    // ===== Auto-completar Correo y Celular desde Contacto =====
    (function(){
      const contactoSel = document.getElementById('id_contacto');
      const correoInput = document.querySelector('input[name="correo"]');
      const celularInput = document.querySelector('input[name="celular"]');
      if(!contactoSel || !correoInput || !celularInput) return;

      async function fetchDatosContacto(contactoId){
        if(!contactoId){ 
          correoInput.value = '';
          celularInput.value = '';
          return;
        }
        try{
          const url = `/ventas/api/contactos/${contactoId}/datos`;
          const res = await fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}});
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          
          // Auto-completar correo y celular
          if(data.correo){
            correoInput.value = data.correo;
          }
          if(data.celular){
            celularInput.value = data.celular;
          }
        }catch(e){
          console.error('Error cargando datos del contacto', e);
        }
      }

      contactoSel.addEventListener('change', (e)=>{
        fetchDatosContacto(e.target.value);
      });

      // Si la página carga con contacto seleccionado, precargar
      if(contactoSel.value){
        fetchDatosContacto(contactoSel.value);
      }
    })();

    // ===== Actualizar símbolo de moneda en totales =====
    (function(){
      const monedaSel = document.querySelector('select[name="moneda"]');
      if(!monedaSel) return;

      const simbolos = {
        'Soles': 'S/.',
        'Dolares': '$'
      };

      function actualizarSimboloMoneda(){
        const moneda = monedaSel.value;
        const simbolo = simbolos[moneda] || 'S/.';
        
        // Actualizar el símbolo en los totales
        const subtotalLabel = document.querySelector('.totals-row:nth-child(1) span:first-child');
        const igvLabel = document.querySelector('.totals-row:nth-child(2) span:first-child');
        const totalLabel = document.querySelector('.totals-row:nth-child(3) span:first-child');
        
        if(subtotalLabel) subtotalLabel.innerHTML = `Subtotal <span style="color:var(--accent-blue);font-weight:600">(${simbolo})</span>`;
        if(igvLabel) igvLabel.innerHTML = `IGV 18% <span style="color:var(--accent-blue);font-weight:600">(${simbolo})</span>`;
        if(totalLabel) totalLabel.innerHTML = `Total <span style="color:var(--accent-blue);font-weight:600">(${simbolo})</span>`;
      }

      monedaSel.addEventListener('change', actualizarSimboloMoneda);
      
      // Ejecutar al cargar para establecer el símbolo inicial
      actualizarSimboloMoneda();
    })();

    // ===== Recalcular cuando cambia el checkbox de IGV =====
    (function(){
      const igvCheckbox = document.querySelector('input[name="incluye_igv"]');
      if(!igvCheckbox) return;

      igvCheckbox.addEventListener('change', function(){
        recalcTotals();
      });
    })();
  </script>
</body>
</html>
