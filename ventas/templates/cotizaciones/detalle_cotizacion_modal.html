{% load widget_tweaks %}
<div class="cotizacion-modal-shell">
  <style>
    #modalDetalle .cotizacion-modal-shell {
      padding: 40px 32px;
      max-height: calc(95vh - 24px);
      overflow-y: auto;
      overscroll-behavior: contain;
    }
    #modalDetalle .cotizacion-modal-shell::-webkit-scrollbar {
      width: 10px;
    }
    #modalDetalle .cotizacion-modal-shell::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.35);
      border-radius: 999px;
    }
    #modalDetalle .cotizacion-modal-shell::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.45);
      border-radius: 999px;
    }
    #modalDetalle .cotizacion-modal-shell::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.65);
    }
    #modalDetalle .cotizacion-modal {
      width: min(1280px, 96vw);
      margin: 0 auto;
      max-height: calc(95vh - 96px);
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(12,20,32,0.88));
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 24px;
      box-shadow: 0 28px 60px rgba(8, 12, 24, 0.48);
      backdrop-filter: blur(26px);
      color: #f8fbff;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 34px;
    }
    #modalDetalle .cot-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }
    #modalDetalle .cot-header-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #modalDetalle .cot-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      font-size: 0.75rem;
      font-weight: 700;
      border-radius: 999px;
      background: rgba(96, 165, 250, 0.18);
      border: 1px solid rgba(96, 165, 250, 0.4);
      color: #93c5fd;
      width: fit-content;
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }
    #modalDetalle .cot-title {
      margin: 0;
      font-size: clamp(1.6rem, 2.2vw, 2rem);
      font-weight: 800;
      letter-spacing: 0.4px;
      color: #f9fbff;
    }
    #modalDetalle .cot-subtitle {
      margin: 0;
      font-size: 0.95rem;
      color: rgba(226, 232, 240, 0.72);
      max-width: 640px;
      line-height: 1.5;
    }
    #modalDetalle .cot-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #modalDetalle .cot-icon-btn {
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.08);
      color: #f8fbff;
      border-radius: 12px;
      width: 42px;
      height: 42px;
      display: grid;
      place-items: center;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform .25s ease, box-shadow .25s ease, background .25s ease;
    }
    #modalDetalle .cot-icon-btn:hover {
      transform: translateY(-2px);
      background: rgba(37, 99, 235, 0.28);
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.35);
    }
    #modalDetalle .cot-icon-btn.ghost {
      background: rgba(255, 255, 255, 0.06);
    }
    #modalDetalle .cot-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    #modalDetalle .cot-meta-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 16px;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 80px;
    }
    #modalDetalle .meta-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(226, 232, 240, 0.65);
    }
    #modalDetalle .meta-value {
      font-weight: 700;
      font-size: 1rem;
      color: #f8fbff;
      word-break: break-word;
    }
    #modalDetalle .cot-card {
      background: rgba(12, 18, 34, 0.72);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 18px;
      padding: 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    #modalDetalle .cot-card-heading h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }
    #modalDetalle .cot-card-heading p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: rgba(226, 232, 240, 0.65);
    }
    #modalDetalle .cot-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 16px 20px;
    }
    #modalDetalle .cot-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #modalDetalle .cot-field label {
      font-size: 0.88rem;
      font-weight: 600;
      color: rgba(226, 232, 240, 0.88);
    }
    #modalDetalle .cot-input,
    #modalDetalle .cot-select,
    #modalDetalle .cot-textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.32);
      background: rgba(255, 255, 255, 0.07);
      color: #f9fbff;
      padding: 12px 14px;
      font-size: 0.95rem;
      transition: border-color .25s ease, box-shadow .25s ease, background .25s ease;
      color-scheme: dark;
    }
    #modalDetalle .cot-input:focus,
    #modalDetalle .cot-select:focus,
    #modalDetalle .cot-textarea:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.7);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
      background: rgba(37, 99, 235, 0.18);
    }
    #modalDetalle .cot-select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, rgba(148,163,184,0.6) 50%), linear-gradient(135deg, rgba(148,163,184,0.6) 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
      background-size: 6px 6px;
      background-repeat: no-repeat;
    }
    #modalDetalle select {
      color: #f9fbff;
      color-scheme: dark;
    }
    #modalDetalle .cot-select option,
    #modalDetalle select option {
      background: #0b1220;
      color: #f9fbff;
    }
    #modalDetalle .cot-select optgroup,
    #modalDetalle select optgroup {
      background: #0b1220;
      color: #f9fbff;
    }
    #modalDetalle .cot-textarea {
      resize: vertical;
      min-height: 110px;
    }
    #modalDetalle .cot-switch {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(12, 18, 34, 0.6);
    }
    #modalDetalle .cot-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      background: rgba(255, 255, 255, 0.08);
      cursor: pointer;
    }
    #modalDetalle .cot-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-color: rgba(37, 99, 235, 0.9);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }
    #modalDetalle .field-error {
      font-size: 0.78rem;
      color: #fecaca;
    }
    #modalDetalle .cot-detail-table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(8, 13, 24, 0.5);
    }
    #modalDetalle .cot-detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }
    #modalDetalle .cot-detail-table thead th {
      text-align: left;
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 0.4px;
      color: rgba(226, 232, 240, 0.7);
      padding: 12px 14px 6px;
    }
    #modalDetalle .cot-detail-table tbody tr {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 14px;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    #modalDetalle .cot-detail-table tbody tr:not(.is-removed):hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(8, 12, 24, 0.38);
    }
    #modalDetalle .cot-detail-table td {
      padding: 14px 16px;
      vertical-align: top;
    }
    #modalDetalle .col-desc textarea {
      min-height: 90px;
    }
    #modalDetalle .col-total,
    #modalDetalle .col-qty,
    #modalDetalle .col-unit,
    #modalDetalle .col-price {
      width: 140px;
    }
    #modalDetalle .cot-row-total {
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(96, 165, 250, 0.28);
      background: rgba(37, 99, 235, 0.12);
      font-weight: 700;
      letter-spacing: 0.4px;
    }
    #modalDetalle .cot-detail-actions {
      display: flex;
      justify-content: flex-end;
    }
    #modalDetalle .cot-btn {
      border: none;
      border-radius: 14px;
      padding: 12px 20px;
      font-weight: 700;
      letter-spacing: 0.4px;
      color: #f8fbff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform .25s ease, box-shadow .25s ease, opacity .25s ease;
    }
    #modalDetalle .cot-btn.primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35);
    }
    #modalDetalle .cot-btn.secondary {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    #modalDetalle .cot-btn.accent {
      background: linear-gradient(135deg, #22d3ee, #3b82f6);
      box-shadow: 0 18px 32px rgba(45, 212, 191, 0.32);
    }
    #modalDetalle .cot-btn.ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.22);
      color: rgba(226, 232, 240, 0.82);
    }
    #modalDetalle .cot-btn.danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
    }
    #modalDetalle .cot-btn:hover {
      transform: translateY(-2px) scale(1.01);
      opacity: 0.95;
    }
    #modalDetalle .cot-summary-card {
      background: rgba(8, 13, 24, 0.6);
      border: 1px solid rgba(96, 165, 250, 0.28);
      border-radius: 18px;
      padding: 18px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    #modalDetalle .summary-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #modalDetalle .summary-label {
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.68);
      text-transform: uppercase;
      letter-spacing: 0.45px;
    }
    #modalDetalle .summary-value {
      font-size: 1.25rem;
      font-weight: 800;
      color: #f8fbff;
    }
    #modalDetalle .cot-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    #modalDetalle .cot-actions-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    #modalDetalle .cot-alert {
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: 600;
    }
    #modalDetalle .cot-alert.error {
      background: rgba(239, 68, 68, 0.16);
      border: 1px solid rgba(239, 68, 68, 0.32);
      color: #fecaca;
    }
    #modalDetalle .cot-delete-toggle {
      display: none;
    }
    #modalDetalle .detalle-row.is-removed {
      display: none;
    }
    #modalDetalle .empty-cell {
      text-align: center;
      padding: 28px;
      color: rgba(226, 232, 240, 0.6);
      font-style: italic;
    }
    @media (max-width: 900px) {
      #modalDetalle .cotizacion-modal {
        padding: 22px;
      }
      #modalDetalle .cot-grid {
        grid-template-columns: 1fr;
      }
      #modalDetalle .cot-actions {
        flex-direction: column;
        align-items: stretch;
      }
      #modalDetalle .cot-actions-right {
        width: 100%;
        flex-direction: column;
        gap: 10px;
      }
      #modalDetalle .cot-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  <div class="cotizacion-modal">
    <header class="cot-modal-header">
      <div class="cot-header-info">
        <span class="cot-pill">{{ cotizacion.estado_coti|default:"En seguimiento" }}</span>
        <h2 class="cot-title">Cotización {{ cotizacion.numero_cotizacion }}</h2>
        <p class="cot-subtitle">
          Actualiza los datos de la oferta, gestiona las partidas y genera nuevamente el PDF cuando lo necesites.
        </p>
      </div>
      <div class="cot-header-actions">
        <button type="button" class="cot-icon-btn ghost" data-action="close" aria-label="Cerrar modal">✕</button>
      </div>
    </header>

    <div class="cot-meta-grid">
      <div class="cot-meta-card">
        <span class="meta-label">Cliente</span>
        <span class="meta-value">{{ cotizacion.cliente.razon_social|default:cotizacion.razon_social }}</span>
      </div>
      <div class="cot-meta-card">
        <span class="meta-label">RUC</span>
        <span class="meta-value">{{ cotizacion.cliente.ruc|default:cotizacion.ruc }}</span>
      </div>
      <div class="cot-meta-card">
        <span class="meta-label">Contacto</span>
        <span class="meta-value">{{ cotizacion.contacto|default:"—" }}</span>
      </div>
      <div class="cot-meta-card">
        <span class="meta-label">Creada</span>
        <span class="meta-value">{{ cotizacion.fecha_creacion|date:"d/m/Y" }}</span>
      </div>
    </div>

    <form id="cotizacion-modal-form" method="post" action="{{ form_action }}" data-contactos-url="{{ contactos_url_template }}">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="cot-alert error">{{ form.non_field_errors }}</div>
      {% endif %}
      {% if detalles_formset.non_form_errors %}
        <div class="cot-alert error">{{ detalles_formset.non_form_errors }}</div>
      {% endif %}

      <section class="cot-card">
        <div class="cot-card-heading">
          <h3>Cabecera de la cotización</h3>
          <p>Los campos se sincronizan automáticamente con el cliente y contacto seleccionados.</p>
        </div>
        <div class="cot-grid">
          <div class="cot-field">
            <label for="{{ form.nombre_cotizacion.id_for_label }}">{{ form.nombre_cotizacion.label }}</label>
            {{ form.nombre_cotizacion|add_class:'cot-input' }}
            {% if form.nombre_cotizacion.errors %}
              <small class="field-error">{{ form.nombre_cotizacion.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.cliente.id_for_label }}">{{ form.cliente.label }}</label>
            {{ form.cliente|add_class:'cot-select' }}
            {% if form.cliente.errors %}
              <small class="field-error">{{ form.cliente.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.contacto.id_for_label }}">{{ form.contacto.label }}</label>
            {{ form.contacto|add_class:'cot-select' }}
            {% if form.contacto.errors %}
              <small class="field-error">{{ form.contacto.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.correo.id_for_label }}">{{ form.correo.label }}</label>
            {{ form.correo|add_class:'cot-input' }}
            {% if form.correo.errors %}
              <small class="field-error">{{ form.correo.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.celular.id_for_label }}">{{ form.celular.label }}</label>
            {{ form.celular|add_class:'cot-input' }}
            {% if form.celular.errors %}
              <small class="field-error">{{ form.celular.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.direccion.id_for_label }}">{{ form.direccion.label }}</label>
            {{ form.direccion|add_class:'cot-input' }}
            {% if form.direccion.errors %}
              <small class="field-error">{{ form.direccion.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.moneda.id_for_label }}">{{ form.moneda.label }}</label>
            {{ form.moneda|add_class:'cot-select' }}
            {% if form.moneda.errors %}
              <small class="field-error">{{ form.moneda.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.forma_pago.id_for_label }}">{{ form.forma_pago.label }}</label>
            {{ form.forma_pago|add_class:'cot-select' }}
            {% if form.forma_pago.errors %}
              <small class="field-error">{{ form.forma_pago.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.validez_oferta.id_for_label }}">{{ form.validez_oferta.label }}</label>
            {{ form.validez_oferta|add_class:'cot-select' }}
            {% if form.validez_oferta.errors %}
              <small class="field-error">{{ form.validez_oferta.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field">
            <label for="{{ form.estado_coti.id_for_label }}">{{ form.estado_coti.label }}</label>
            {{ form.estado_coti|add_class:'cot-select' }}
            {% if form.estado_coti.errors %}
              <small class="field-error">{{ form.estado_coti.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="cot-field cot-switch" style="grid-column: span 2;">
            {{ form.incluye_igv|add_class:'cot-checkbox' }}
            <label for="{{ form.incluye_igv.id_for_label }}">{{ form.incluye_igv.label }}</label>
            {% if form.incluye_igv.errors %}
              <small class="field-error">{{ form.incluye_igv.errors|join:", " }}</small>
            {% endif %}
          </div>
        </div>
      </section>

      <section class="cot-card">
        <div class="cot-card-heading">
          <h3>Alcance de la oferta</h3>
          <p>Este texto aparece en el documento PDF generado para el cliente.</p>
        </div>
        <div class="cot-field">
          {{ form.alcance_total_oferta|add_class:'cot-textarea'|attr:'rows:4' }}
          {% if form.alcance_total_oferta.errors %}
            <small class="field-error">{{ form.alcance_total_oferta.errors|join:", " }}</small>
          {% endif %}
        </div>
      </section>

      <section class="cot-card">
        <div class="cot-card-heading">
          <h3>Partidas y conceptos</h3>
          <p>Gestiona los ítems de la cotización. Puedes clonar, editar o eliminar cada partida.</p>
        </div>

        {{ detalles_formset.management_form }}

        <div class="cot-detail-table-wrap">
          <table class="cot-detail-table">
            <thead>
              <tr>
                <th style="width: 36%;">Descripción</th>
                <th style="width: 12%;">Unidad</th>
                <th style="width: 12%;">Cantidad</th>
                <th style="width: 16%;">Precio Unit.</th>
                <th style="width: 16%;">Subtotal</th>
                <th style="width: 8%; text-align:center;">Acciones</th>
              </tr>
            </thead>
            <tbody id="detalle-rows">
              {% for detalle_form in detalles_formset %}
                {% if detalle_form.non_field_errors %}
                  <tr>
                    <td colspan="6">
                      <div class="cot-alert error">{{ detalle_form.non_field_errors }}</div>
                    </td>
                  </tr>
                {% endif %}
                <tr class="detalle-row{% if detalle_form.DELETE.value %} is-removed{% endif %}" data-form-index="{{ forloop.counter0 }}">
                  <td class="col-desc">
                    {{ detalle_form.id }}
                    {{ detalle_form.descripcion|add_class:'cot-textarea'|attr:'rows:3'|attr:'data-field:descripcion' }}
                    {% if detalle_form.descripcion.errors %}
                      <small class="field-error">{{ detalle_form.descripcion.errors|join:", " }}</small>
                    {% endif %}
                  </td>
                  <td class="col-unit">
                    {{ detalle_form.unidad|add_class:'cot-select' }}
                    {% if detalle_form.unidad.errors %}
                      <small class="field-error">{{ detalle_form.unidad.errors|join:", " }}</small>
                    {% endif %}
                  </td>
                  <td class="col-qty">
                    {{ detalle_form.cantidad|add_class:'cot-input'|attr:'data-field:cantidad' }}
                    {% if detalle_form.cantidad.errors %}
                      <small class="field-error">{{ detalle_form.cantidad.errors|join:", " }}</small>
                    {% endif %}
                  </td>
                  <td class="col-price">
                    {{ detalle_form.precio_unitario|add_class:'cot-input'|attr:'data-field:precio' }}
                    {% if detalle_form.precio_unitario.errors %}
                      <small class="field-error">{{ detalle_form.precio_unitario.errors|join:", " }}</small>
                    {% endif %}
                  </td>
                  <td class="col-total">
                    <span class="cot-row-total" data-field="total-display">
                      {{ moneda_simbolo }} {{ detalle_form.instance.get_precio_total_safe|default:0|floatformat:2 }}
                    </span>
                  </td>
                  <td class="col-actions" style="text-align:center;">
                    {% if detalle_form.DELETE %}
                      {{ detalle_form.DELETE|add_class:'cot-delete-toggle' }}
                    {% endif %}
                    <button type="button" class="cot-icon-btn danger" data-action="remove" title="Eliminar ítem" aria-label="Eliminar ítem">✕</button>
                  </td>
                </tr>
              {% empty %}
                <tr class="detalle-row">
                  <td colspan="6" class="empty-cell">Aún no hay partidas registradas.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="cot-detail-actions">
          <button type="button" class="cot-btn secondary" data-action="add-row" id="add-detalle-btn">
            + Añadir nuevo ítem
          </button>
        </div>

        {% with empty_form=detalles_formset.empty_form %}
          <template id="detalle-row-template">
            <tr class="detalle-row" data-form-index="__prefix__">
              <td class="col-desc">
                {{ empty_form.id }}
                {{ empty_form.descripcion|add_class:'cot-textarea'|attr:'rows:3'|attr:'data-field:descripcion' }}
              </td>
              <td class="col-unit">
                {{ empty_form.unidad|add_class:'cot-select' }}
              </td>
              <td class="col-qty">
                {{ empty_form.cantidad|add_class:'cot-input'|attr:'data-field:cantidad' }}
              </td>
              <td class="col-price">
                {{ empty_form.precio_unitario|add_class:'cot-input'|attr:'data-field:precio' }}
              </td>
              <td class="col-total">
                <span class="cot-row-total" data-field="total-display">{{ moneda_simbolo }} 0.00</span>
              </td>
              <td class="col-actions" style="text-align:center;">
                {% if empty_form.DELETE %}
                  {{ empty_form.DELETE|add_class:'cot-delete-toggle' }}
                {% endif %}
                <button type="button" class="cot-icon-btn danger" data-action="remove" title="Eliminar ítem" aria-label="Eliminar ítem">✕</button>
              </td>
            </tr>
          </template>
        {% endwith %}
      </section>

      <section class="cot-summary-card">
        <div class="summary-item">
          <span class="summary-label">Subtotal</span>
          <span class="summary-value" data-total="subtotal">{{ moneda_simbolo }} {{ totales.subtotal|default:0|floatformat:2 }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">IGV (18%)</span>
          <span class="summary-value" data-total="igv">
            {% if form.incluye_igv.value %}
              {{ moneda_simbolo }} {{ totales.igv|default:0|floatformat:2 }}
            {% else %}
              —
            {% endif %}
          </span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total</span>
          <span class="summary-value" data-total="total">{{ moneda_simbolo }} {{ totales.total|default:0|floatformat:2 }}</span>
        </div>
      </section>

      <div class="cot-actions">
        <button type="button" class="cot-btn ghost" data-action="close">Cerrar sin guardar</button>
        <div class="cot-actions-right">
          <button type="submit" class="cot-btn primary">Guardar cambios</button>
          <button type="submit" class="cot-btn accent" name="generar_pdf" value="1">Guardar y abrir PDF</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
window.initCotizacionModal = function initCotizacionModal() {
  const modal = document.getElementById('modalDetalle');
  const form = modal ? modal.querySelector('#cotizacion-modal-form') : null;
  if (!form || form.dataset.modalReady === '1') {
    return;
  }
  form.dataset.modalReady = '1';

  const rowsContainer = form.querySelector('#detalle-rows');
  const addBtn = form.querySelector('#add-detalle-btn');
  const template = form.querySelector('#detalle-row-template');
  const totalFormsInput = form.querySelector('#id_detalles-TOTAL_FORMS');
  const monedaSelect = form.querySelector('select[name="moneda"]');
  const igvCheckbox = form.querySelector('input[name="incluye_igv"]');
  const subtotalNode = form.querySelector('[data-total="subtotal"]');
  const igvNode = form.querySelector('[data-total="igv"]');
  const totalNode = form.querySelector('[data-total="total"]');
  const contactosUrlTpl = form.dataset.contactosUrl || '';

  const getSymbol = () => (monedaSelect && monedaSelect.value === 'Dolares') ? '$' : 'S/';
  const formatCurrency = (value) => `${getSymbol()} ${Number(value || 0).toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  const parseValue = (input) => {
    const raw = parseFloat(input?.value?.replace(/[^0-9.,-]/g, '').replace(',', '.') || '');
    return Number.isFinite(raw) ? raw : 0;
  };

  const ensurePlaceholderRow = () => {
    if (!rowsContainer) return;
    const visibleRows = rowsContainer.querySelectorAll('.detalle-row:not(.is-removed)');
    const placeholder = rowsContainer.querySelector('.empty-cell')?.closest('tr');
    if (visibleRows.length === 0) {
      if (!placeholder) {
        const tr = document.createElement('tr');
        tr.className = 'detalle-row';
        tr.innerHTML = '<td colspan="6" class="empty-cell">Aún no hay partidas registradas.</td>';
        rowsContainer.appendChild(tr);
      }
    } else if (placeholder) {
      placeholder.remove();
    }
  };

  const updateRowTotal = (row) => {
    if (!row || row.classList.contains('is-removed')) {
      return 0;
    }
    const qtyInput = row.querySelector('[data-field="cantidad"]');
    const priceInput = row.querySelector('[data-field="precio"]');
    const deleteInput = row.querySelector('input[name$="-DELETE"]');
    const totalDisplay = row.querySelector('[data-field="total-display"]');

    if (deleteInput && deleteInput.checked) {
      if (totalDisplay) totalDisplay.textContent = formatCurrency(0);
      return 0;
    }

    const quantity = parseValue(qtyInput);
    const price = parseValue(priceInput);
    const total = quantity * price;
    if (totalDisplay) {
      totalDisplay.textContent = formatCurrency(total);
    }
    return total;
  };

  const refreshTotals = () => {
    let subtotal = 0;
    rowsContainer?.querySelectorAll('.detalle-row').forEach((row) => {
      subtotal += updateRowTotal(row);
    });
    const includeIgv = igvCheckbox ? igvCheckbox.checked : false;
    const igv = includeIgv ? subtotal * 0.18 : 0;
    const total = subtotal + igv;

    if (subtotalNode) subtotalNode.textContent = formatCurrency(subtotal);
    if (igvNode) igvNode.textContent = includeIgv ? formatCurrency(igv) : '—';
    if (totalNode) totalNode.textContent = formatCurrency(total);
  };

  const markRowForDeletion = (row) => {
    const deleteInput = row.querySelector('input[name$="-DELETE"]');
    if (deleteInput) {
      deleteInput.checked = true;
      row.classList.add('is-removed');
    } else {
      row.remove();
      if (totalFormsInput) {
        const current = parseInt(totalFormsInput.value, 10) || 0;
        totalFormsInput.value = Math.max(current - 1, 0);
      }
    }
  };

  const addRow = () => {
    if (!template || !totalFormsInput) return;
    const nextIndex = parseInt(totalFormsInput.value, 10) || 0;
    const html = template.innerHTML.replace(/__prefix__/g, nextIndex);
    const wrapper = document.createElement('tbody');
    wrapper.innerHTML = html.trim();
    const newRow = wrapper.firstElementChild;
    rowsContainer.appendChild(newRow);
    totalFormsInput.value = nextIndex + 1;
    ensurePlaceholderRow();
    refreshTotals();
  };

  const handleRemoveClick = (event) => {
    const trigger = event.target.closest('[data-action="remove"]');
    if (!trigger) return;
    const row = trigger.closest('.detalle-row');
    if (!row) return;
    markRowForDeletion(row);
    ensurePlaceholderRow();
    refreshTotals();
  };

  const handleValueInput = (event) => {
    if (!event.target.matches('[data-field="cantidad"], [data-field="precio"]')) return;
    const row = event.target.closest('.detalle-row');
    updateRowTotal(row);
    refreshTotals();
  };

  const handleToggleChange = (event) => {
    if (!event.target.matches('select[name="moneda"], input[name="incluye_igv"]')) return;
    refreshTotals();
  };

  const showNotification = (message, type = 'info') => {
    if (typeof window.showNotification === 'function') {
      window.showNotification(message, type);
    } else {
      console.log(`${type.toUpperCase()}: ${message}`);
    }
  };

  const closeModal = () => {
    if (typeof window.cerrarModal === 'function') {
      window.cerrarModal();
    } else if (modal) {
      modal.style.display = 'none';
    }
  };

  const loadContactos = async (clienteId, selectedId) => {
    const contactoSelect = form.querySelector('select[name="contacto"]');
    if (!contactoSelect) return;
    if (!clienteId) {
      contactoSelect.innerHTML = '<option value="">— Selecciona —</option>';
      contactoSelect.disabled = true;
      return;
    }
    contactoSelect.disabled = true;
    contactoSelect.innerHTML = '<option value="">Cargando…</option>';
    try {
      const url = contactosUrlTpl.replace('{id}', encodeURIComponent(clienteId));
      const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      contactoSelect.innerHTML = '<option value="">— Selecciona —</option>';
      (data.results || []).forEach((item) => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.label;
        if (String(item.id) === String(selectedId)) {
          option.selected = true;
        }
        contactoSelect.appendChild(option);
      });
      contactoSelect.disabled = false;
    } catch (error) {
      console.error('Error cargando contactos', error);
      contactoSelect.innerHTML = '<option value="">No disponible</option>';
      contactoSelect.disabled = true;
    }
  };

  const initializeContactos = () => {
    const clienteSelect = form.querySelector('select[name="cliente"]');
    const contactoSelect = form.querySelector('select[name="contacto"]');
    if (!clienteSelect || !contactoSelect || !contactosUrlTpl) return;
    const initialValue = contactoSelect.value;
    clienteSelect.addEventListener('change', (event) => {
      loadContactos(event.target.value, '');
    });
    if (clienteSelect.value) {
      loadContactos(clienteSelect.value, initialValue);
    }
  };

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const submitter = event.submitter;
    const formData = new FormData(form);
    if (submitter && submitter.name && !formData.has(submitter.name)) {
      formData.append(submitter.name, submitter.value || '1');
    }
    const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfValue = csrfInput ? csrfInput.value : '';
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfValue,
        },
      });
      const isJson = response.headers.get('content-type')?.includes('application/json');
      const payload = isJson ? await response.json() : {};
      if (response.ok && payload.success) {
        showNotification('Cotización actualizada correctamente', 'success');
        closeModal();
        if (payload.pdf_url) {
          window.open(payload.pdf_url, '_blank', 'noopener');
        }
        setTimeout(() => window.location.reload(), 800);
      } else if (payload && payload.html) {
        const container = document.getElementById('contenidoModal');
        if (container) {
          container.innerHTML = payload.html;
          setTimeout(() => window.initCotizacionModal && window.initCotizacionModal(), 0);
        }
      } else {
        const message = payload?.message || 'No se pudo guardar la cotización.';
        throw new Error(message);
      }
    } catch (error) {
      console.error('Error guardando cotización', error);
      showNotification(error.message || 'Ocurrió un error al guardar', 'error');
    }
  });

  form.addEventListener('click', (event) => {
    if (event.target.closest('[data-action="close"]')) {
      event.preventDefault();
      closeModal();
    }
  });

  rowsContainer?.addEventListener('click', handleRemoveClick);
  form.addEventListener('input', handleValueInput);
  form.addEventListener('change', handleToggleChange);
  addBtn?.addEventListener('click', addRow);

  initializeContactos();
  ensurePlaceholderRow();
  refreshTotals();
};

window.initCotizacionModal();
</script>