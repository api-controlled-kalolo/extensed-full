{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ERP · Dashboard de Cotizaciones</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --primary-dark:#0a0e1a; --secondary-dark:#1a1f2e; --accent-dark:#2a3441;
      --primary-blue:#2563eb; --secondary-blue:#1d4ed8; --light-blue:#3b82f6; --accent-blue:#60a5fa;
      --pure-white:#ffffff; --light-gray:#f8fafc; --medium-gray:#94a3b8; --dark-gray:#334155;
      --glass-bg:rgba(255,255,255,.08); --glass-border:rgba(255,255,255,.12);
      --gradient-primary:linear-gradient(135deg,#1e293b 0%,#0f172a 50%,#1e293b 100%);
      --gradient-blue:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
      --gradient-accent:linear-gradient(135deg,#3b82f6 0%,#1e40af 100%);
      --shadow-soft:0 4px 20px rgba(0,0,0,.15);
      --transition:all .4s cubic-bezier(.4,0,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; color:var(--pure-white); background:var(--gradient-primary); overflow-x:hidden}

    .background-effects{position:fixed; inset:0; pointer-events:none; z-index:-1}
    .gradient-orb{position:absolute; width:420px; height:420px; border-radius:50%; filter:blur(50px); opacity:.35; mix-blend-mode:screen; animation:float 14s ease-in-out infinite}
    .orb-1{background:var(--gradient-blue); top:-100px; left:-80px}
    .orb-2{background:var(--gradient-accent); bottom:-120px; right:-60px; animation-delay:2s}
    .orb-3{background:radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8); top:40%; left:55%; animation-delay:4s}
    .grid-pattern{position:absolute; inset:0; background-image:linear-gradient(rgba(255,255,255,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.06) 1px,transparent 1px); background-size:40px 40px; mask-image:radial-gradient(ellipse at center, rgba(0,0,0,.8), transparent 70%); animation:gridShift 30s linear infinite}
    @keyframes float{50%{transform:translateY(-20px) scale(1.03)}} @keyframes gridShift{to{background-position:40px 40px}}

    .header{position:sticky; top:0; z-index:30; padding:12px 20px; background:rgba(10,14,26,.55); backdrop-filter:blur(16px); border-bottom:1px solid var(--glass-border)}
    .header-content{max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between}
    .logo-section{display:flex; align-items:center; gap:12px}
    .logo-section img{height:48px; filter:brightness(1.2)}
    .system-title{margin:0; font-size:1.05rem; font-weight:800; letter-spacing:.4px}

    .container{max-width:1100px; margin:28px auto; padding:0 20px}
    .breadcrumb{color:var(--accent-blue); font-size:.9rem; margin-bottom:6px}
    .page-head{display:flex; align-items:end; justify-content:space-between; gap:16px; margin-bottom:18px}
    .title{margin:0; font-size:1.6rem; font-weight:800}
    .desc{margin:4px 0 0; color:var(--light-gray)}

    .card{background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:20px; padding:18px; backdrop-filter:blur(25px); box-shadow:var(--shadow-soft)}
    .card + .card{margin-top:16px}

    /* Filtros */
  .filters{display:grid; grid-template-columns:repeat(6, minmax(0,1fr)) auto; gap:10px}
    .form-control, .form-select{
      width:100%; padding:.7rem .9rem; border-radius:12px; border:1px solid var(--glass-border);
      background:rgba(255,255,255,.06); color:var(--pure-white); transition:var(--transition);
      color-scheme:dark; appearance:none;
    }
    select{
      color:var(--pure-white);
      color-scheme:dark;
    }
    .form-control::placeholder{color:var(--medium-gray)}
    .form-control:focus,.form-select:focus{outline:2px solid var(--primary-blue); outline-offset:2px; background:rgba(37,99,235,.08)}
    .form-select option, select option{background:#0b1220; color:var(--pure-white)}
    .form-select optgroup{background:#0b1220; color:var(--pure-white)}
    .btn{display:inline-grid; place-items:center; border-radius:12px; padding:.7rem 1rem; font-weight:700; cursor:pointer; border:1px solid var(--glass-border); background:var(--glass-bg); color:var(--pure-white); text-decoration:none; transition:var(--transition)}
    .btn-primary{background:var(--gradient-blue); border-color:transparent}

    /* KPIs */
    .kpis{display:grid; grid-template-columns:repeat(6, 1fr); gap:10px}
    .kpi{padding:14px; border-radius:16px; border:1px solid var(--glass-border); background:rgba(255,255,255,.06)}
    .kpi .label{font-size:.85rem; color:var(--medium-gray)}
    .kpi .value{font-size:1.25rem; font-weight:800}
    .kpi .hint{font-size:.8rem; color:var(--accent-blue); margin-top:2px}

    /* Grids de gráficas */
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid-3{display:grid; grid-template-columns:2fr 2fr 1fr; gap:10px}
    canvas{width:100%; height:320px}

    @media (max-width:1024px){
      .filters{grid-template-columns:repeat(3, minmax(0,1fr))}
      .kpis{grid-template-columns:repeat(3,1fr)}
      .grid-2,.grid-3{grid-template-columns:1fr}
    }
    @media (max-width:640px){
      .filters{grid-template-columns:1fr}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <!-- Fondo -->
  <div class="background-effects">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
    <div class="grid-pattern"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <img src="https://i.ibb.co/wFRJS8cw/textoanhe-removebg-preview.png" alt="Logo de la empresa"/>
        <h1 class="system-title">ERP · Dashboard de Cotizaciones</h1>
      </div>
      <nav style="display:flex;gap:10px">
        <a class="btn" href="{% url 'ventas:cotizaciones_list' %}">Listado</a>
        <a class="btn" href="{% url 'ventas:cotizacion_create' %}">Nueva</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="breadcrumb">Ventas / Cotizaciones / Dashboard</div>
    <div class="page-head">
      <div>
        <h2 class="title">Resumen y Analítica</h2>
        <p class="desc">Indicadores clave, tendencias y composición de las cotizaciones.</p>
      </div>
    </div>

    <!-- Filtros -->
    <section class="card">
      <form method="get" class="filters">
        <input class="form-control" type="date" name="desde" value="{{ desde }}"/>
        <input class="form-control" type="date" name="hasta" value="{{ hasta }}"/>

        <select class="form-select" name="unidad">
          <option value="">— Unidad de negocio —</option>
          {% for un in unidades %}
            <option value="{{ un.id }}" {% if unidad_id|add:'' == un.id|add:'' %}selected{% endif %}>{{ un }}</option>
          {% endfor %}
        </select>

        <select class="form-select" name="proyecto">
          <option value="">— Proyecto —</option>
          {% for p in proyectos %}
            <option value="{{ p.id }}" {% if proyecto_id|add:'' == p.id|add:'' %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>

        <select class="form-select" name="cliente">
          <option value="">— Cliente —</option>
          {% for c in clientes %}
            <option value="{{ c.id }}" {% if cliente_id|add:'' == c.id|add:'' %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>

        <select class="form-select" name="estado">
          {% for value, label in estado_choices %}
            <option value="{{ value }}" {% if estado_selected == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>

        <button class="btn btn-primary" type="submit">Aplicar</button>
      </form>
    </section>

    <!-- KPIs -->
    <section class="kpis" style="margin-top:10px">
      <div class="kpi">
        <div class="label">Cotizaciones</div>
        <div class="value">{{ total_cotizaciones_display }}</div>
        <div class="hint">Periodo: {{ desde }} → {{ hasta }}</div>
      </div>
      <div class="kpi">
        <div class="label">Ítems</div>
        <div class="value">{{ total_items_display }}</div>
        <div class="hint">Total líneas</div>
      </div>
      <div class="kpi">
        <div class="label">Subtotal</div>
        <div class="value">S/ {{ subtotal_display }}</div>
        <div class="hint">Sin IGV</div>
      </div>
      <div class="kpi">
        <div class="label">IGV (18%)</div>
        <div class="value">S/ {{ igv_display }}</div>
        <div class="hint">Calculado</div>
      </div>
      <div class="kpi">
        <div class="label">Total</div>
        <div class="value">S/ {{ total_display }}</div>
        <div class="hint">Con IGV</div>
      </div>
      <div class="kpi">
        <div class="label">Ticket Promedio</div>
        <div class="value">S/ {{ ticket_prom_display }}</div>
        <div class="hint">{% if growth_pct >= 0 %}▲{% else %}▼{% endif %} Crec.: {{ growth_pct_display }}%</div>
      </div>
    </section>

    <!-- Gráficas -->
    <section class="grid-3" style="margin-top:10px">
      <div class="card">
        <h3 style="margin:0 0 8px">Cotizaciones por día (últimos 30 días)</h3>
        <canvas id="chartDay"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Monto por mes (últimos 12 meses)</h3>
        <canvas id="chartMonth"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Mix por unidad</h3>
        <canvas id="chartUnidad"></canvas>
      </div>
    </section>

    <section class="grid-2" style="margin-top:10px">
      <div class="card">
        <h3 style="margin:0 0 8px">Top clientes por monto</h3>
        <canvas id="chartTopClientes"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Estados de cotizaciones</h3>
        <canvas id="chartEstado"></canvas>
      </div>
    </section>
  </main>

  <!-- Datos (inyectados desde Django) -->
  <script>
    const DATA = JSON.parse('{{ dashboard_data|escapejs }}');

    const moneyFmt = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    const intFmt = new Intl.NumberFormat('es-PE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    function makeGradient(ctx, baseColor){
      const g = ctx.createLinearGradient(0, 0, 0, 320);
      g.addColorStop(0, baseColor.replace('1)', '.35)'));
      g.addColorStop(1, baseColor.replace('1)', '.03)'));
      return g;
    }

    window.addEventListener('DOMContentLoaded', () => {
      {
        const el = document.getElementById('chartDay');
        const ctx = el.getContext('2d');
        const base = 'rgba(96,165,250,1)';
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: DATA.seriesDays,
            datasets: [{
              label: 'Cotizaciones',
              data: DATA.seriesCounts,
              borderColor: base,
              backgroundColor: makeGradient(ctx, base),
              borderWidth: 2,
              tension: .25,
              pointRadius: 2,
              fill: true,
            }]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,.06)' } },
              y: {
                grid: { color: 'rgba(255,255,255,.06)' },
                beginAtZero: true,
                ticks: { callback: (v) => intFmt.format(v) }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${intFmt.format(c.parsed.y)}` } }
            }
          }
        });
      }

      {
        const el = document.getElementById('chartMonth');
        const ctx = el.getContext('2d');
        const base = 'rgba(37,99,235,1)';
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: DATA.monthsLabels,
            datasets: [{
              label: 'Subtotal',
              data: DATA.monthsAmounts,
              backgroundColor: makeGradient(ctx, base),
              borderColor: base,
              borderWidth: 1.5
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { grid: { color: 'rgba(255,255,255,.06)' } },
              y: {
                grid: { color: 'rgba(255,255,255,.06)' },
                beginAtZero: true,
                ticks: { callback: (v) => moneyFmt.format(v) }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${moneyFmt.format(c.parsed.y)}` } }
            }
          }
        });
      }

      {
        const el = document.getElementById('chartUnidad');
        const ctx = el.getContext('2d');
        const palette = [
          'rgba(96,165,250,1)',
          'rgba(59,130,246,1)',
          'rgba(37,99,235,1)',
          'rgba(14,165,233,1)',
          'rgba(99,102,241,1)',
        ];
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: DATA.unidadesLabels,
            datasets: [{ data: DATA.unidadesCounts, backgroundColor: palette, borderWidth: 1 }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: { callbacks: { label: (c) => `${c.label}: ${intFmt.format(c.parsed)}` } }
            },
            cutout: '60%'
          }
        });
      }

      {
        const el = document.getElementById('chartTopClientes');
        const ctx = el.getContext('2d');
        const base = 'rgba(14,165,233,1)';
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: DATA.topClientsLabels,
            datasets: [{
              label: 'Subtotal',
              data: DATA.topClientsValues,
              backgroundColor: makeGradient(ctx, base),
              borderColor: base,
              borderWidth: 1.5
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,.06)' },
                beginAtZero: true,
                ticks: { callback: (v) => moneyFmt.format(v) }
              },
              y: { grid: { display: false } }
            },
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${moneyFmt.format(c.parsed.x)}` } }
            }
          }
        });
      }

      {
        const el = document.getElementById('chartEstado');
        const ctx = el.getContext('2d');
        const baseBar = 'rgba(96,165,250,1)';
        const lineColor = 'rgba(255,255,255,0.8)';
        new Chart(ctx, {
          data: {
            labels: DATA.stateLabels,
            datasets: [
              {
                type: 'bar',
                label: 'Cotizaciones',
                data: DATA.stateCounts,
                backgroundColor: makeGradient(ctx, baseBar),
                borderColor: 'rgba(37,99,235,1)',
                borderWidth: 1.5,
                yAxisID: 'yCounts'
              },
              {
                type: 'line',
                label: 'Montos',
                data: DATA.stateAmounts,
                borderColor: lineColor,
                backgroundColor: 'transparent',
                pointBackgroundColor: lineColor,
                pointBorderColor: lineColor,
                borderWidth: 2,
                tension: .25,
                yAxisID: 'yAmount'
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,.06)' } },
              yCounts: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,.06)' },
                ticks: { callback: (v) => intFmt.format(v) }
              },
              yAmount: {
                position: 'right',
                beginAtZero: true,
                grid: { drawOnChartArea: false },
                ticks: { callback: (v) => moneyFmt.format(v) }
              }
            },
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: (ctxTooltip) => {
                    if (ctxTooltip.datasetIndex === 0) {
                      return `${ctxTooltip.dataset.label}: ${intFmt.format(ctxTooltip.parsed.y)}`;
                    }
                    return `${ctxTooltip.dataset.label}: ${moneyFmt.format(ctxTooltip.parsed.y)}`;
                  }
                }
              }
            }
          }
        });
      }
    });

    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.querySelectorAll('*').forEach(el => {
        el.style.animationDuration = '0.01ms';
        el.style.transitionDuration = '0.01ms';
      });
    }
  </script>
</body>
</html>
