{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ERP · Cotizaciones</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary-dark:#0a0e1a; --secondary-dark:#1a1f2e; --accent-dark:#2a3441;
      --primary-blue:#2563eb; --secondary-blue:#1d4ed8; --light-blue:#3b82f6; --accent-blue:#60a5fa;
      --pure-white:#ffffff; --light-gray:#f8fafc; --medium-gray:#64748b; --dark-gray:#334155;
      --glass-bg:rgba(255,255,255,.08); --glass-border:rgba(255,255,255,.12);
      --gradient-primary:linear-gradient(135deg,#1e293b 0%,#0f172a 50%,#1e293b 100%);
      --gradient-blue:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
      --gradient-accent:linear-gradient(135deg,#3b82f6 0%,#1e40af 100%);
      --shadow-soft:0 4px 20px rgba(0,0,0,.15);
      --shadow-medium:0 8px 32px rgba(0,0,0,.24);
      --transition:all .4s cubic-bezier(.4,0,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      color:var(--pure-white); background:var(--gradient-primary); overflow-x:hidden;
    }

    /* Fondo animado */
    .background-effects{position:fixed; inset:0; pointer-events:none; z-index:-1}
    .gradient-orb{position:absolute; width:420px; height:420px; border-radius:50%; filter:blur(50px); opacity:.35; mix-blend-mode:screen; animation:float 14s ease-in-out infinite}
    .orb-1{background:var(--gradient-blue); top:-100px; left:-80px}
    .orb-2{background:var(--gradient-accent); bottom:-120px; right:-60px; animation-delay:2s}
    .orb-3{background:radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8); top:40%; left:55%; animation-delay:4s}
    .grid-pattern{position:absolute; inset:0; background-image:linear-gradient(rgba(255,255,255,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.06) 1px,transparent 1px); background-size:40px 40px; mask-image:radial-gradient(ellipse at center, rgba(0,0,0,.8), transparent 70%); animation:gridShift 30s linear infinite}
    @keyframes float{50%{transform:translateY(-20px) scale(1.03)}}
    @keyframes gridShift{to{background-position:40px 40px}}

    /* Header */
    .header{position:sticky; top:0; z-index:30; padding:12px 20px; background:rgba(10,14,26,.55); backdrop-filter:blur(16px); border-bottom:1px solid var(--glass-border); animation:slideInDown .6s ease both}
    .header-content{max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between}
    .logo-section{display:flex; align-items:center; gap:12px}
    .logo-section img{height:48px; filter:brightness(1.2); transition:var(--transition)}
    .logo-section img:hover{filter:brightness(1.5)}
    .system-title{margin:0; font-size:1.05rem; font-weight:800; letter-spacing:.4px}

    .user-section{display:flex; align-items:center; gap:18px}
    .system-status{display:flex; align-items:center; gap:8px; color:var(--accent-blue); font-weight:600}
    .status-indicator{width:10px; height:10px; border-radius:50%; background:var(--accent-blue); box-shadow:0 0 12px var(--accent-blue)}
    .user-profile{display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:16px; background:var(--glass-bg); border:1px solid var(--glass-border)}
    .user-avatar{width:32px; height:32px; border-radius:10px; display:grid; place-items:center; background:var(--gradient-blue); font-weight:700}

    /* Contenedor */
    .container{max-width:1100px; margin:28px auto; padding:0 20px; animation:fadeInUp .5s ease both}
    .breadcrumb{color:var(--accent-blue); font-size:.9rem; margin-bottom:6px}
    .page-head{display:flex; align-items:end; justify-content:space-between; gap:16px; margin-bottom:18px}
    .title{margin:0; font-size:1.6rem; font-weight:800}
    .desc{margin:4px 0 0; color:var(--light-gray)}

    /* Tarjetas */
    .card{background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:20px; padding:18px; backdrop-filter:blur(25px); box-shadow:var(--shadow-soft)}
    .card + .card{margin-top:16px}

    /* Filtros */
    .filters{display:grid; grid-template-columns:2fr 1fr 1fr 1fr auto; gap:10px}
    .form-control, .form-select{
      width:100%; padding:.7rem .9rem; border-radius:12px; border:1px solid var(--glass-border);
      background:rgba(255,255,255,.06); color:var(--pure-white); transition:var(--transition);
    }
    .form-control::placeholder{color:var(--medium-gray)}
    .form-control:focus,.form-select:focus{outline:2px solid var(--primary-blue); outline-offset:2px; background:rgba(37,99,235,.08)}
    .btn{display:inline-grid; place-items:center; border-radius:12px; padding:.7rem 1rem; font-weight:700; cursor:pointer; border:1px solid var(--glass-border); background:var(--glass-bg); color:var(--pure-white); text-decoration:none; transition:var(--transition)}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--gradient-blue); border-color:transparent}
    .btn-secondary{background:linear-gradient(135deg,#334155,#1f2937); border-color:transparent}
    .btn-icon{display:grid;place-items:center;width:38px;height:38px;border-radius:12px;background:var(--glass-bg);border:1px solid var(--glass-border)}

    /* Tabla */
    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    thead th{font-size:.9rem; font-weight:800; color:var(--light-gray); text-align:left; padding:0 12px}
    tbody tr{background:rgba(255,255,255,.06); border:1px solid var(--glass-border); border-radius:12px}
    tbody td{padding:12px}
    tbody tr>td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr>td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
    .col-actions{white-space:nowrap; display:flex; gap:8px; align-items:center}
    .badge{display:inline-block; padding:.28rem .6rem; border-radius:999px; background:rgba(59,130,246,.16); border:1px solid rgba(96,165,250,.35); color:var(--accent-blue); font-weight:700; font-size:.8rem}

    /* Paginación */
    .pagination{display:flex; gap:6px; align-items:center; justify-content:flex-end; margin-top:12px}
    .page-link{padding:.45rem .8rem; border-radius:10px; border:1px solid var(--glass-border); background:var(--glass-bg); color:var(--pure-white); text-decoration:none}
    .page-link[aria-current="page"]{background:var(--gradient-blue); border-color:transparent}

    /* Animaciones */
    @keyframes slideInDown{from{opacity:0; transform:translateY(-8px)} to{opacity:1; transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    /* Accesibilidad */
    .focusable:focus{outline:2px solid var(--primary-blue); outline-offset:2px}

    @media (max-width:900px){ .filters{grid-template-columns:1fr 1fr 1fr} }
    @media (max-width:640px){ .filters{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <!-- Fondo -->
  <div class="background-effects">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
    <div class="grid-pattern"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <img src="https://i.ibb.co/wFRJS8cw/textoanhe-removebg-preview.png" alt="Logo de la empresa"/>
        <h1 class="system-title">ERP · Cotizaciones</h1>

        <nav class="nav-icons" aria-label="Navegación rápida" style="display:flex;gap:10px;margin-left:10px">
          <a class="btn-icon focusable" href="{% url 'ventas:modulo_ventas' %}" title="Inicio" aria-label="Inicio">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10.5L12 3l9 7.5"/><path d="M5 11.5v9h4v-6h4v6h4v-9"/></svg>
          </a>
          <a class="btn-icon focusable" href="{% url 'ventas:cotizaciones_list' %}" title="Listado" aria-label="Listado de cotizaciones">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h10l4 4v12H4z"/><path d="M14 4v4h4"/><path d="M8 12h8M8 16h5"/></svg>
          </a>
          <a class="btn-icon focusable" href="{% url 'ventas:cotizacion_create' %}" title="Nueva cotización" aria-label="Nueva cotización">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          </a>
        </nav>
      </div>

      <div class="user-section">
        <div class="system-status"><div class="status-indicator" aria-hidden="true"></div><span>Sistema Operativo</span></div>
        <div class="user-profile" role="group" aria-label="Perfil de usuario">
          <div class="user-avatar" aria-hidden="true">{{ user.first_name.0|default:'U' }}</div>
          <div class="user-details">
            <div class="user-name">Hola, {{ user.get_full_name|default:user.username|default:'Usuario' }}!</div>
            <div class="user-role">Ventas</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido -->
  <main class="container">
    <div class="breadcrumb">Ventas / Cotizaciones</div>
    <div class="page-head">
      <div>
        <h2 class="title">Listado de Cotizaciones</h2>
        <p class="desc">Consulta, filtra y ordena las cotizaciones generadas.</p>
      </div>
    </div>

    <!-- Filtros -->
    <section class="card" aria-labelledby="filtros-title">
      <h3 id="filtros-title" style="margin:0 0 10px; font-size:1.05rem; font-weight:800;">Filtros</h3>
      <form method="get" class="filters" role="search" style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr auto; gap:10px;">
        <input class="form-control" type="search" name="q" value="{{ q }}" placeholder="Buscar por Nº, nombre, RUC, correo, dirección…" aria-label="Buscar"/>
        <select class="form-select" name="cliente" aria-label="Cliente">
          <option value="">— Cliente —</option>
          {% for c in clientes %}
            <option value="{{ c.id }}" {% if cliente_id|add:'' == c.id|add:'' %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <select class="form-select" name="estado" aria-label="Estado">
          {% for value, label in estados_choices %}
            <option value="{{ value }}" {% if value == estado %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <input class="form-control" type="date" name="desde" value="{{ desde }}" aria-label="Desde"/>
        <input class="form-control" type="date" name="hasta" value="{{ hasta }}" aria-label="Hasta"/>
        <button class="btn btn-primary" type="submit" aria-label="Aplicar filtros">Aplicar</button>
      </form>
    </section>

    <!-- Tabla -->
    <section class="card" aria-labelledby="tabla-title">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;">
        <h3 id="tabla-title" style="margin:0; font-size:1.05rem; font-weight:800;">Resultados</h3>
        <a class="btn btn-secondary" href="{% url 'ventas:cotizacion_create' %}">+ Nueva cotización</a>
      </div>

      <div class="table-wrap">
        <table aria-describedby="tabla-title">
          <thead>
            <tr>
              <th>Proyecto</th>
              <th>
                {% with col='numero_cotizacion' %}
                  {% if order == col %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}" title="Ordenar por número (desc)">Nº Cotización ▲</a>
                  {% elif order == '-'|add:col %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}" title="Ordenar por número (asc)">Nº Cotización ▼</a>
                  {% else %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}" title="Ordenar por número">Nº Cotización</a>
                  {% endif %}
                {% endwith %}
              </th>
              <th>
                {% with col='nombre_cotizacion' %}
                  {% if order == col %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}">Descripción ▲</a>
                  {% elif order == '-'|add:col %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Descripción ▼</a>
                  {% else %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Descripción</a>
                  {% endif %}
                {% endwith %}
              </th>
              <th>
                {% with col='fecha_creacion' %}
                  {% if order == col %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}">Fecha Cotización ▲</a>
                  {% elif order == '-'|add:col %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Fecha Cotización ▼</a>
                  {% else %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}">Fecha Cotización</a>
                  {% endif %}
                {% endwith %}
              </th>
              <th>Cliente</th>
              <th>RUC</th>
              <th>Moneda</th>
              <th>Monto Cotización</th>
              <th>Monto en Soles</th>
              <th>IGV</th>
              <th>
                {% with col='estado_coti' %}
                  {% if order == col %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}">Estado ▲</a>
                  {% elif order == '-'|add:col %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Estado ▼</a>
                  {% else %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Estado</a>
                  {% endif %}
                {% endwith %}
              </th>
              <th>
                {% with col='fecha_actualizacion_estado' %}
                  {% if order == col %}
                    <a class="focusable" href="?{{ query_without_order }}&order=-{{ col }}">Últ. Estado ▲</a>
                  {% elif order == '-'|add:col %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Últ. Estado ▼</a>
                  {% else %}
                    <a class="focusable" href="?{{ query_without_order }}&order={{ col }}">Últ. Estado</a>
                  {% endif %}
                {% endwith %}
              </th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for c in page_obj.object_list %}
              <tr>
                <td>
                  {% if c.cliente.proyecto_principal %}
                    {{ c.cliente.proyecto_principal.nombre|truncatechars:15 }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td><span class="badge">{{ c.numero_cotizacion }}</span></td>
                <td>{{ c.nombre_cotizacion|truncatechars:25 }}</td>
                <td>{{ c.fecha_creacion|date:"d/m/Y" }}</td>
                <td>{{ c.cliente.razon_social|truncatechars:20 }}</td>
                <td>{{ c.cliente.ruc }}</td>
                <td>
                  <span class="badge" style="{% if c.moneda == 'Dolares' %}background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.35);color:#22c55e;{% endif %}">
                    {% if c.moneda == 'Dolares' %}USD{% else %}PEN{% endif %}
                  </span>
                </td>
                <td>
                  <strong>
                    {% if c.moneda == 'Dolares' %}${% else %}S/{% endif %} 
                    {{ c.total_con_igv|floatformat:2 }}
                  </strong>
                </td>
                <td><strong>S/ {{ c.total_soles|floatformat:2 }}</strong></td>
                <td>
                  {% if c.incluye_igv %}
                    {% if c.moneda == 'Dolares' %}${% else %}S/{% endif %} 
                    {{ c.igv_monto|floatformat:2 }}
                  {% else %}
                    <small style="color:var(--medium-gray)">No incluye</small>
                  {% endif %}
                </td>
                <td>
                  <select onchange="cambiarEstado({{ c.id }}, this.value)" data-cotizacion-id="{{ c.id }}" 
                          style="background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:8px;padding:4px 8px;color:var(--pure-white);font-size:0.8rem;">
                    <option value="En Negociación" {% if c.estado_coti == 'En Negociación' %}selected{% endif %}>En Negociación</option>
                    <option value="Ganado" {% if c.estado_coti == 'Ganado' %}selected{% endif %}>Ganado</option>
                    <option value="Perdida" {% if c.estado_coti == 'Perdida' %}selected{% endif %}>Perdida</option>
                  </select>
                </td>
                <td>
                  <small style="color:var(--medium-gray)" id="fecha-{{ c.id }}">
                    {% if c.fecha_actualizacion_estado %}
                      {{ c.fecha_actualizacion_estado|date:"d/m/Y H:i" }}
                    {% else %}
                      —
                    {% endif %}
                  </small>
                </td>
                <td class="col-actions">
                  <a class="btn-icon focusable" href="#" title="Ver detalle" aria-label="Ver detalle">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8Z"/><circle cx="12" cy="12" r="3"/></svg>
                  </a>
                  <a class="btn-icon focusable" href="#" title="Editar" aria-label="Editar">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                  </a>
                  <a class="btn-icon focusable" href="#" title="Descargar PDF" aria-label="Descargar PDF">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/></svg>
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="13" style="padding:16px;">No se encontraron cotizaciones con los criterios aplicados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
      <nav class="pagination" role="navigation" aria-label="Paginación">
        {% if page_obj.has_previous %}
          <a class="page-link focusable" href="?{% if query_without_page %}{{ query_without_page }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}

        <span class="page-link" aria-current="page">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a class="page-link focusable" href="?{% if query_without_page %}{{ query_without_page }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
        {% endif %}
      </nav>
      {% endif %}
    </section>
  </main>

  <script>
    // Efecto sutil al cargar tarjetas
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.card').forEach((el, i) => {
        el.style.transition = 'transform .4s ease, box-shadow .4s ease';
        el.addEventListener('mouseenter', () => el.style.transform = 'translateY(-2px)');
        el.addEventListener('mouseleave', () => el.style.transform = 'translateY(0)');
      });
    });

    // Respeto a reduce motion
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.querySelectorAll('*').forEach(el => {
        el.style.animationDuration = '0.01ms';
        el.style.transitionDuration = '0.01ms';
      });
    }

    // Función para cambiar estado via AJAX
    function cambiarEstado(cotizacionId, nuevoEstado) {
      if (!cotizacionId || !nuevoEstado) return;
      
      fetch(`{% url 'ventas:cambiar_estado_cotizacion' 0 %}`.replace('0', cotizacionId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: `estado=${encodeURIComponent(nuevoEstado)}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar fecha
          const fechaElement = document.getElementById(`fecha-${cotizacionId}`);
          if (fechaElement) {
            fechaElement.textContent = data.fecha_actualizacion;
          }
          
          // Mostrar notificación discreta
          showNotification('Estado actualizado correctamente', 'success');
        } else {
          // Revertir el select al valor anterior
          location.reload();
          showNotification('Error al actualizar el estado: ' + data.error, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        location.reload();
        showNotification('Error de conexión', 'error');
      });
    }

    // Función para obtener CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Función para mostrar notificaciones discretas
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        padding: 12px 16px; border-radius: 8px; color: white; font-weight: 600;
        background: ${type === 'success' ? 'var(--gradient-blue)' : 'linear-gradient(135deg, #dc2626, #b91c1c)'};
        box-shadow: var(--shadow-soft); animation: slideInFade 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Auto-eliminar después de 3 segundos
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
  </script>
</body>
</html>
